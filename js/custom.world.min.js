var margins={top:20,right:50,left:100,bottom:75},parse_date=d3.time.format("%m/%Y").parse,height=400-margins.top-margins.bottom;localStorage.clear();localStorage.setItem("month","01");var div=d3.select("body").append("div").attr("class","tooltip").style("opacity",0);d3.select("#month").on("change",function(){var b=this.options[this.selectedIndex].innerHTML,c=d3.select(this),d=c.prop("value");localStorage.setItem("month",d);d3.selectAll(".selected_month").text(b);c.prop("value","");render()});
var render=_.debounce(function(){d3.selectAll(".svg").remove();d3.selectAll(".heading").remove();var b="#a50026 #d73027 #f46d43 #fdae61 #fee090 #ffffbf #e0f3f8 #abd9e9 #74add1 #4575b4 #313695".split(" ").reverse(),c=localStorage.getItem("month"),d=window.innerWidth-100-margins.right-margins.left;d3.csv("data/world_all.csv",function(f){function t(a,b,c,f){a=d3.select(a).append("svg").attr("width",d+margins.left+margins.right).attr("height",110).attr("class","svg").call(b).selectAll("bar").data(f);
    a.enter().append("rect");a.attr("x",function(a){return l(parse_date(a.date))}).attr("width",A).attr("y",0).attr("height",80).translate([margins.left,0]).style("fill",_.compose(c,\u0192("anomaly"))).on("mouseover touchstart",function(a){d3.select(this).attr("height",100);b.show.call(this,a)}).on("mouseout touchend",function(a){d3.select(this).attr("height",80);b.hide.call(this,a)});return a}function k(a,b,c){a.append("path#"+b).attr("fill","none").attr("stroke",c).attr("stroke-width",2.5).translate([margins.left,
    margins.top]);return a}function p(a,b,c){return d3.select(a).transition().duration(1E3).ease("sin-in-out").attr("d",b(c))}function w(a,b,f){f.split("_")[0].substr(1);var e=a.append("g").attr("class","focus").style("display","none");e.append("line").attr("class","y0").attr({x1:0,y1:0,x2:0,y2:height});a.append("rect").attr("class","overlay").attr("width",d).attr("height",height).on("mouseover touchstart",function(){e.style("display",null)}).on("mouseout touchend",function(){e.style("display","none");
    div.transition().duration(250).style("opacity",0)}).on("mousemove touchmove",function(){var a=l.invert(d3.mouse(this)[0]),d=B(b,a,1),e=b[d-1],d=b[d];void 0===d&&(d=Infinity);a=a-e.key>d.key-a?d:e;e=[l(parse_date(a.date))+margins.left,margins.top];d3.select(f+" line.y0").translate(e);div.transition().duration(100).style("opacity",.9);div.html('<h4 class="text-center">'+stringDate(c)+" ("+a.year+')</h4><ul class="list-unstyled"<li>Historical Avg: '+a.historic_avg+" degrees (C)</li><li>Actual Avg: "+
        a.actual_avg+" degrees (C)</li><li>Departure from Avg: "+a.anomaly+" degrees (C)</li></ul>").style("top",d3.event.pageY-108+"px").style("left",d3.event.pageX-28+"px")}).translate([margins.left,margins.top]);return a}f.forEach(function(a){a.date=a.month+"/"+a.year;a.actual_avg=_.round(+a.actual_avg,2);a.historic_avg=_.round(+a.historic_avg,2);a.anomaly=_.round(+a.anomaly,2)});var g=_.sortByOrder(f,["month","year"],["asc","asc"]),e=dataFilter(g,"ocean_land",c),h=dataFilter(g,"land",c),g=dataFilter(g,
    "ocean",c),q=e[0].historic_avg,x=h[0].historic_avg,y=g[0].historic_avg,r=maxMin(e,"actual_avg"),u=maxMin(h,"actual_avg"),v=maxMin(g,"actual_avg"),B=d3.bisector(function(a){return parse_date(a.date)}).right,l=d3.time.scale().domain(d3.extent(f,_.compose(parse_date,\u0192("date")))).range([0,d]),m=yScale(e,height),n=yScale(h,height);f=yScale(g,height);var z=getAxis(l,"bottom"),C=getAxis(m,"left"),D=getAxis(n,"left"),E=getAxis(f,"left"),A=barWidth(d,e);d3.selectAll(".selected-month").text(stringDate(c));
    var F=stripColors(b,e);d3.select("#avg_temp_text").text(q);d3.select("#hottest").text(r.max[4].actual_avg);d3.select("#hottest-year").text(r.max[4].year);d3.select("#least-hottest").text(r.min[0].actual_avg);d3.select("#least-hottest-year").text(r.min[0].year);q=showAxises("#world_div","#avg_temp_line",d,z,C);r=lineGenerator(l,m,"actual_avg");m=lineGenerator(l,m,"historic_avg");q=k(q,"temp_line","firebrick");p("#temp_line",r,e);k(q,"temp_avg_line","yellow");p("#temp_avg_line",m,e);w(q,e,"#world_div");
    m=d3.tip().attr("class","d3-tip").html(function(a){return'<h4 class="text-center">'+stringDate(c)+"("+a.year+')</h4><ul class="list-unstyled"><li>Historical Avg: '+a.historic_avg+" degrees (C)</li><li>Actual Avg: "+a.actual_avg+" degrees (C)</li><li>Departure from Avg: "+a.anomaly+" degrees (C)</li></ul>"});drawLegend("#world_div",b,e);t("#world_div",m,F,e);d3.select("#avg_max_text").text(x);d3.select("#maxtemp").text(u.max[4].actual_avg);d3.select("#maxtemp-year").text(u.max[4].year);d3.select("#least-maxtemp").text(u.min[0].actual_avg);
    d3.select("#least-maxtemp-year").text(u.min[0].year);e=showAxises("#land_div","#max_temp",d,z,D);x=lineGenerator(l,n,"actual_avg");n=lineGenerator(l,n,"historic_avg");e=k(e,"max_line","firebrick");p("#max_line",x,h);k(e,"max_avg_line","yellow");p("#max_avg_line",n,h);w(e,h,"#land_div");e=d3.tip().attr("class","d3-tip").html(function(a){return'<h4 class="text-center">'+stringDate(c)+"("+a.year+')</h4><ul class="list-unstyled"><li>Historical Avg: '+a.historic_avg+" degrees (C)</li><li>Actual Avg: "+
        a.actual_avg+" degrees (C)</li><li>Departure from Avg: "+a.anomaly+" degrees (C)</li></ul>"});n=stripColors(b,h);drawLegend("#land_div",b,h);t("#land_div",e,n,h);d3.select("#avg_min_text").text(y);d3.select("#mintemp").text(v.max[4].actual_avg);d3.select("#mintemp-year").text(v.max[4].year);d3.select("#least-mintemp").text(v.min[0].actual_avg);d3.select("#least-mintemp-year").text(v.min[0].year);h=showAxises("#ocean_div","#min_temp",d,z,E);y=lineGenerator(l,f,"actual_avg");f=lineGenerator(l,f,"historic_avg");
    h=k(h,"min_line","firebrick");p("#min_line",y,g);k(h,"min_avg_line","yellow");p("#min_avg_line",f,g);w(h,g,"#ocean_div");h=d3.tip().attr("class","d3-tip").html(function(a){return'<h4 class="text-center">'+stringDate(c)+"("+a.year+')</h4><ul class="list-unstyled"><li>Historical Avg: '+a.historic_avg+" degrees (C)</li><li>Actual Avg: "+a.actual_avg+" degrees (C)</li><li>Departure from Avg: "+a.anomaly+" degrees (C)</li></ul>"});f=stripColors(b,g);drawLegend("#ocean_div",b,g);t("#ocean_div",h,f,g);g=d3.selectAll(".row");g.classed("opaque",!1);g.classed("hide",!1);d3.selectAll("#load").classed("hide",!0)})},400);function dataFilter(b,c,d){return b.filter(function(b){return b.type===c&&b.month===d})}function maxMin(b,c){var d=_.sortBy(b,c),f=d.slice(0,5),d=d.slice(-5);return{min:f,max:d}}function barWidth(b,c){return _.floor(b/c.length,3)}function yScale(b,c){return d3.scale.linear().range([0,c]).domain([d3.max(b,\u0192("actual_avg")),0])}function stripColors(b,c){return d3.scale.quantize().domain(d3.extent(c,\u0192("anomaly"))).range(b)}
function drawLegend(b,c,d){d3.select(b).append("h4").attr("class","text-center heading").text("Departure from Average (Anomaly degrees (C))");d=stripColors(c,d);c=b.substr(1);b=d3.select(b).append("svg").classed("svg",!0).classed("legend",!0).attr("width",1E3);b.append("g").attr("class","legend-"+c).attr("width",900).translate([margins.left,margins.top]);d=d3.legend.color().shapeWidth(70).orient("horizontal").labelFormat(d3.format(".02f")).scale(d);b.select(".legend-"+c).call(d);return b}
function getAxis(b,c){return d3.svg.axis().scale(b).orient(c)}function showAxises(b,c,d,f,t){var k=d3.select(b).append("svg.svg");k.attr("width",d+margins.left+margins.right).attr("height",height+margins.top+margins.bottom).attr("id",c);k.append("g").attr("class","x axis").translate([margins.left,height+margins.top]);d3.selectAll(b+" g.x").call(f);k.append("g").attr("class","y axis").translate([margins.left,margins.top]);d3.selectAll(b+" g.y").call(t);k.append("text").attr("transform","rotate(-90)").attr("x",-height/3).attr("y",6).attr("dy","3.71em").style("text-anchor","end").text("Avg. Temperature (C)");return k}function lineGenerator(b,c,d){return d3.svg.line().interpolate("monotone").x(function(c){return b(parse_date(c.date))}).y(function(b){return c(b[d])})}function stringDate(b){return"January February March April May June July August September October November December".split(" ")[parseInt(b,10)-1]}render();window.addEventListener("resize",render);