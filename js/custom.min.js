var margins={top:20,right:50,left:100,bottom:75},parse_date=d3.time.format("%m/%Y").parse,height=400-margins.top-margins.bottom;localStorage.clear();localStorage.setItem("path","all_by_state/US.csv");localStorage.setItem("month","01");localStorage.setItem("state-name","US");var div=d3.select("body").append("div").attr("class","tooltip").style("opacity",0);
d3.select("#state").on("change",function(){var a=this.options[this.selectedIndex].innerHTML,c=d3.select(this),b=c.prop("value"),d="all_by_state/"+b+".csv";localStorage.getItem("month");d3.selectAll(".selected_state").text(a);c.prop("value","");localStorage.setItem("path",d);localStorage.setItem("state",b);localStorage.setItem("state-name",a);render()});
d3.select("#month").on("change",function(){var a=this.options[this.selectedIndex].innerHTML,c=d3.select(this),b=c.prop("value");localStorage.setItem("month",b);d3.selectAll(".selected_month").text(a);c.prop("value","");render()});
var render=_.debounce(function(){d3.selectAll(".svg").remove();d3.selectAll(".heading").remove();var a="#543005 #8c510a #bf812d #dfc27d #f6e8c3 #f5f5f5 #c7eae5 #80cdc1 #35978f #01665e #003c30".split(" "),c="#a50026 #d73027 #f46d43 #fdae61 #fee090 #ffffbf #e0f3f8 #abd9e9 #74add1 #4575b4 #313695".split(" ").reverse(),b=localStorage.getItem("path"),d=localStorage.getItem("month"),g=localStorage.getItem("state-name"),z="US"===g?"the "+g:g,e=window.innerWidth-100-margins.right-margins.left;d3.csv(b,function(b){function g(a,b,d,c){a=d3.select(a).append("svg").attr("width",e+margins.left+margins.right).attr("height",110).attr("class","svg").call(b).selectAll("bar").data(c);a.enter().append("rect");a.attr("x",function(a){return m(parse_date(a.date))}).attr("width",G).attr("y",0).attr("height",80).translate([margins.left,0]).style("fill",_.compose(d,\u0192("anomaly"))).on("mouseover touchstart",function(a){d3.select(this).attr("height",100);b.show.call(this,a)}).on("mouseout touchend",function(a){d3.select(this).attr("height",80);b.hide.call(this,a)});return a}function r(a,b,d){a.append("path#"+b).attr("fill","none").attr("stroke",d).attr("stroke-width",2.5).translate([margins.left,margins.top]);return a}function t(a,b,d){return d3.select(a).transition().duration(1E3).ease("sin-in-out").attr("d",b(d))}function D(a,b,c,g){var h=c.split("_")[0].substr(1),f=a.append("g").attr("class","focus").style("display","none");f.append("line").attr("class","y0").attr({x1:0,y1:0,x2:0,y2:height});a.append("rect").attr("class","overlay").attr("width",e).attr("height",height).on("mouseover touchstart",function(){f.style("display",null)}).on("mouseout touchend",function(){f.style("display","none");div.transition().duration(250).style("opacity",0)}).on("mousemove touchmove",function(){var a=m.invert(d3.mouse(this)[0]),u=H(b,a,1),e=b[u-1],u=b[u];void 0===u&&(u=Infinity);a=a-e.key>u.key-a?u:e;e=[m(parse_date(a.date))+margins.left,margins.top];d3.select(c+" line.y0").translate(e);div.transition().duration(100).style("opacity",.9);div.html('<h4 class="text-center">'+
        stringDate(a.month)+" ("+a.year+')</h4><ul class="list-unstyled"<li>Historical Avg: '+monthAvg(k,h,d)+" "+g+"</li><li>Actual Avg: "+a.value+" "+g+"</li><li>Departure from Avg: "+a.anomaly+" "+g+"</li></ul>").style("top",d3.event.pageY-108+"px").style("left",d3.event.pageX-28+"px")}).translate([margins.left,margins.top]);return a}b.forEach(function(a){a.date=a.month+"/"+a.year;a.value=+a.value;a.anomaly=+a.anomaly});var k=avgValues(b),n=_.sortByOrder(b,["month","year"],["asc","asc"]),v=dataFilter(n,
    "drought",d,k),h=dataFilter(n,"max",d,k),f=dataFilter(n,"min",d,k),p=dataFilter(n,"precip",d,k),l=dataFilter(n,"temp",d,k),n=maxMin(v,"value"),A=maxMin(h,"value"),B=maxMin(f,"value"),C=maxMin(p,"value"),q=maxMin(l,"value"),H=d3.bisector(function(a){return parse_date(a.date)}).right,m=d3.time.scale().domain(d3.extent(b,_.compose(parse_date,\u0192("date")))).range([0,e]),w=yScale(h,height),x=yScale(f,height);b=yScale(p,height);var y=yScale(l,height),E=getAxis(m,"bottom"),I=getAxis(w,"left"),J=getAxis(x,
    "left"),K=getAxis(b,"left"),F=getAxis(y,"left"),G=barWidth(e,p);d3.selectAll(".selected-month").text(stringDate(d));d3.selectAll(".selected-state").text(z);var L=stripColors(c,l);d3.select("#avg_temp_text").text(monthAvg(k,"temp",d));d3.select("#hottest").text(q.max[4].value);d3.select("#hottest-year").text(q.max[4].year);d3.select("#least-hottest").text(q.min[0].value);d3.select("#least-hottest-year").text(q.min[0].year);q=showAxises("#temp_div","#avg_temp_line",e,E,F,"Avg. Temperature (F)");F=lineGenerator(m,
    y,"value");y=lineGenerator(m,y,"mean");q=r(q,"temp_line","steelblue");t("#temp_line",F,l);r(q,"temp_avg_line","yellow");t("#temp_avg_line",y,l);D(q,l,"#temp_div","degrees");y=d3.tip().attr("class","d3-tip").html(function(a){return'<h4 class="text-center">'+stringDate(d)+"("+a.year+')</h4><ul class="list-unstyled"><li>Historical Avg: '+monthAvg(k,"temp",d)+" degrees</li><li>Actual Avg: "+a.value+" degrees</li><li>Departure from Avg: "+a.anomaly+" degrees</li></ul>"});drawLegend("#temp_div",c,l,"temp");
    g("#temp_div",y,L,l);d3.select("#avg_max_text").text(monthAvg(k,"max",d));d3.select("#maxtemp").text(A.max[4].value);d3.select("#maxtemp-year").text(A.max[4].year);d3.select("#least-maxtemp").text(A.min[0].value);d3.select("#least-maxtemp-year").text(A.min[0].year);l=showAxises("#max_div","#max_temp",e,E,I,"Avg. Max. Temperature (F)");A=lineGenerator(m,w,"value");w=lineGenerator(m,w,"mean");l=r(l,"max_line","firebrick");t("#max_line",A,h);r(l,"max_avg_line","yellow");t("#max_avg_line",w,h);D(l,h,
        "#max_div","degrees");w=d3.tip().attr("class","d3-tip").html(function(a){return'<h4 class="text-center">'+stringDate(d)+"("+a.year+')</h4><ul class="list-unstyled"><li>Historical Avg: '+monthAvg(k,"max",d)+" degrees</li><li>Actual Avg: "+a.value+" degrees</li><li>Departure from Avg: "+a.anomaly+" degrees</li></ul>"});l=stripColors(c,h);drawLegend("#max_div",c,h,"max");g("#max_div",w,l,h);d3.select("#avg_min_text").text(monthAvg(k,"min",d));d3.select("#mintemp").text(B.max[4].value);d3.select("#mintemp-year").text(B.max[4].year);
    d3.select("#least-mintemp").text(B.min[0].value);d3.select("#least-mintemp-year").text(B.min[0].year);h=showAxises("#min_div","#min_temp",e,E,J,"Avg. Min. Temperature (F)");B=lineGenerator(m,x,"value");x=lineGenerator(m,x,"mean");h=r(h,"min_line","steelblue");t("#min_line",B,f);r(h,"min_avg_line","yellow");t("#min_avg_line",x,f);D(h,f,"#min_div","degrees");h=d3.tip().attr("class","d3-tip").html(function(a){return'<h4 class="text-center">'+stringDate(d)+"("+a.year+')</h4><ul class="list-unstyled"><li>Historical Avg: '+
        monthAvg(k,"min",d)+" degrees</li><li>Actual Avg: "+a.value+" degrees</li><li>Departure from Avg: "+a.anomaly+" degrees</li></ul>"});x=stripColors(c,f);drawLegend("#min_div",c,f,"min");g("#min_div",h,x,f);d3.select("#avg_precip_text").text(monthAvg(k,"precip",d));d3.select("#avg_drought_text").text(monthAvg(k,"drought",d));d3.select("#wettest").text(C.max[4].value);d3.select("#wettest-year").text(C.max[4].year);d3.select("#least-wettest").text(C.min[0].value);d3.select("#least-wettest-year").text(C.min[0].year);
    f=showAxises("#precip_div","#avg_precip",e,E,K,"Avg. Precipitation (Inches)");C=lineGenerator(m,b,"value");b=lineGenerator(m,b,"mean");f=r(f,"precip_line","steelblue");t("#precip_line",C,p);r(f,"precip_avg_line","yellow");t("#precip_avg_line",b,p);b=d3.tip().attr("class","d3-tip").html(function(a){return'<h4 class="text-center">'+stringDate(d)+" ("+a.year+')</h4><ul class="list-unstyled"<li>Historical Avg: '+monthAvg(k,"precip",d)+" inches</li><li>Actual Avg: "+a.value+" inches</li><li>Departure from Avg: "+
        a.anomaly+" inches</li></ul>"});D(f,p,"#precip_div","inches");f=stripColors(a,p);drawLegend("#precip_div",a,p,"precip");g("#precip_div",b,f,p);d3.select("#least-driest").text(n.max[4].value);d3.select("#least-driest-year").text(n.max[4].year);d3.select("#driest").text(n.min[0].value);d3.select("#driest-year").text(n.min[0].year);p=stripColors(a,v);n=d3.tip().attr("class","d3-tip").html(function(a){return'<h4 class="text-center">'+stringDate(d)+" ("+a.year+')</h4><ul class="list-unstyled"<li>Historical Avg: '+
        monthAvg(k,"drought",d)+"</li><li>Actual Avg: "+a.value+"</li><li>Departure from Avg: "+a.anomaly+"</li></ul>"});drawLegend("#drought_div",a,v,"drought");g("#drought_div",n,p,v);v=d3.selectAll(".row");v.classed("opaque",!1);v.classed("hide",!1);d3.selectAll("#load").classed("hide",!0)})},400);function dataFilter(a,c,b,d){a=a.filter(function(a){return b?a.type===c&&a.month===b:a.type===c});b&&a.forEach(function(a){a.mean=monthAvg(d,c,b)});return a}
function monthAvg(a,c,b){return a[c][parseInt(b,10)-1].value.toFixed(2)}function avgValues(a){var c=d3.range(1,13),b={drought:[],max:[],min:[],precip:[],temp:[]},d,g;["drought","max","min","precip","temp"].forEach(function(z){c.forEach(function(c){c=10>c?"0"+c:""+c;d=_.findWhere(a,{month:c,type:z});g=d.value-d.anomaly;b[z].push({key:c,value:g})})});return b}function maxMin(a,c){var b=_.sortBy(a,c),d=b.slice(0,5),b=b.slice(-5);return{min:d,max:b}}
function barWidth(a,c){return _.floor(a/c.length,3)}function yScale(a,c){return d3.scale.linear().range([0,c]).domain([d3.max(a,\u0192("value")),0])}function stripColors(a,c){return d3.scale.quantize().domain(d3.extent(c,\u0192("anomaly"))).range(a)}
function drawLegend(a,c,b,d){d="precip"==d?"inches":"drought"==d?"":"degrees";d3.select(a).append("h4").attr("class","text-center heading").text("Departure from Average (Anomaly "+d+")");b=stripColors(c,b);c=a.substr(1);a=d3.select(a).append("svg").classed("svg",!0).classed("legend",!0).attr("width",1E3);a.append("g").attr("class","legend-"+c).attr("width",900).translate([margins.left,margins.top]);b=d3.legend.color().shapeWidth(70).orient("horizontal").labelFormat(d3.format(".02f")).scale(b);a.select(".legend-"+
    c).call(b);return a}function getAxis(a,c){return d3.svg.axis().scale(a).orient(c)}
function showAxises(a,c,b,d,g,z){var e=d3.select(a).append("svg.svg");e.attr("width",b+margins.left+margins.right).attr("height",height+margins.top+margins.bottom).attr("id",c);e.append("g").attr("class","x axis").translate([margins.left,height+margins.top]);d3.selectAll(a+" g.x").call(d);e.append("g").attr("class","y axis").translate([margins.left,margins.top]);d3.selectAll(a+" g.y").call(g);e.append("text").attr("transform","rotate(-90)").attr("x",-height/3).attr("y",6).attr("dy","3.71em").style("text-anchor","end").text(z);return e}function lineGenerator(a,c,b){return d3.svg.line().interpolate("monotone").x(function(b){return a(parse_date(b.date))}).y(function(a){return c(a[b])})}function stringDate(a){return"January February March April May June July August September October November December".split(" ")[parseInt(a,10)-1]}render();window.addEventListener("resize",render);